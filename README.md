# 空间推理LLM微调指南

## 项目概述

本项目用于对大型语言模型进行空间推理能力的微调，使用Chain-of-Thought (COT) 训练数据。

## 数据概况

- **总样本数**: 2400条
- **数据类型**: 6种空间关系
  - 点-点关系 (200条)
  - 点-线关系 (300条)
  - 点-多边形关系 (300条)
  - 线-线关系 (700条)
  - 线-多边形关系 (400条)
  - 多边形-多边形关系 (500条)

## 环境准备

### 1. 安装依赖

```bash
pip install -r requirements.txt
```

### 2. 数据预处理

```bash
python finetune_prepare.py
```

这将生成以下文件：
- `finetune_data/train.jsonl` - 训练集
- `finetune_data/val.jsonl` - 验证集
- `finetune_data/test.jsonl` - 测试集

## 微调配置

### 1. 基础模型选择

推荐使用以下模型之一：
- `Qwen/Qwen2-7B-Instruct` (推荐)
- `THUDM/chatglm3-6b`
- `baichuan-inc/Baichuan2-7B-Chat`

### 2. 硬件要求

- **最低配置**: 16GB GPU显存
- **推荐配置**: 24GB+ GPU显存
- **CPU训练**: 不推荐，速度很慢

### 3. 训练参数调优

根据你的硬件配置调整 `finetune_config.yaml`：

```yaml
training:
  per_device_train_batch_size: 2  # 显存不足时降低
  gradient_accumulation_steps: 8  # 相应增加
  learning_rate: 1e-5  # 可以尝试更低的学习率
```

## 开始训练

```bash
python finetune_script.py
```

训练过程中会：
- 自动保存检查点
- 显示训练日志
- 在验证集上评估模型

## 模型评估

```bash
python evaluate_model.py <model_path> finetune_data/test.jsonl
```

## 工程实践建议

### 1. 数据质量优化

- **数据平衡**: 确保每种空间关系类型有足够的样本
- **边界情况**: 包含复杂的几何场景
- **数据增强**: 通过旋转、缩放等变换增加数据多样性

### 2. 训练策略

- **渐进式训练**: 先用简单样本训练，再逐步增加难度
- **学习率调度**: 使用warmup和衰减策略
- **早停机制**: 避免过拟合

### 3. 模型选择

- **LoRA微调**: 节省显存，适合快速实验
- **全参数微调**: 效果更好，但需要更多资源
- **QLoRA**: 在低显存设备上的选择

### 4. 评估指标

- **准确率**: 空间关系预测的正确率
- **推理质量**: 生成的推理步骤是否合理
- **泛化能力**: 在未见过的几何场景上的表现

## 常见问题

### Q: 训练时显存不足怎么办？
A: 
1. 降低batch_size
2. 增加gradient_accumulation_steps
3. 使用gradient_checkpointing
4. 考虑使用QLoRA

### Q: 模型效果不好怎么办？
A:
1. 增加训练数据量
2. 调整学习率
3. 增加训练轮数
4. 检查数据质量

### Q: 如何提高推理质量？
A:
1. 优化prompt设计
2. 增加推理步骤的详细程度
3. 使用更好的基础模型
4. 增加训练数据的多样性

## 数据量建议

### 当前状态
- **2400条样本**: 基础可行，但需要优化

### 目标数据量
- **5000-10000条**: 理想状态
- **每种关系800-1500条**: 确保覆盖度

### 数据质量提升
1. **增加边界情况**
2. **添加负样本**
3. **提高数据多样性**
4. **确保标注一致性**

## 性能优化

### 1. 训练优化
- 使用混合精度训练 (bf16)
- 启用gradient_checkpointing
- 使用LoRA减少参数量

### 2. 推理优化
- 使用量化技术
- 优化prompt长度
- 调整生成参数

## 监控和调试

### 1. 训练监控
```bash
tensorboard --logdir spatial_reasoning_model
```

### 2. 模型分析
- 检查训练损失曲线
- 分析验证集性能
- 查看生成的推理过程

## 部署建议

### 1. 模型服务化
- 使用FastAPI构建API
- 集成到现有系统
- 考虑模型量化

### 2. 性能优化
- 使用模型并行
- 实现缓存机制
- 优化推理速度

## 扩展方向

### 1. 多模态扩展
- 结合图像输入
- 支持3D几何
- 集成CAD数据

### 2. 应用场景
- 地理信息系统
- 建筑设计
- 机器人导航
- 游戏AI

## 联系和支持

如有问题，请检查：
1. 依赖版本是否正确
2. 硬件配置是否满足要求
3. 数据格式是否正确
4. 配置文件参数是否合理 